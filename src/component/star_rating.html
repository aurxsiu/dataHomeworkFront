<template id="star-rating-template">
  <style>
    .star-rating {
      direction: rtl;
      unicode-bidi: bidi-override;
      font-size: 10px;
      user-select: none;
      display: inline-block;
    }

    .star-rating span {
      cursor: pointer;
      color: lightgray;
      transition: color 0.2s;
    }

    .star-rating span.hover,
    .star-rating span.selected {
      color: gold;
    }
  </style>
  <div class="star-rating" id="rating">
    <span data-value="5">&#9733;</span>
    <span data-value="4">&#9733;</span>
    <span data-value="3">&#9733;</span>
    <span data-value="2">&#9733;</span>
    <span data-value="1">&#9733;</span>
  </div>
</template>

<script type="module">
  class StarRating extends HTMLElement {
    constructor() {
      super();
      const template = document.getElementById("star-rating-template");
      const content = template.content.cloneNode(true);
      this.attachShadow({ mode: "open" }).appendChild(content);
    }

    connectedCallback() {
      const stars = this.shadowRoot.querySelectorAll("#rating span");
      let currentRating = 0;

      stars.forEach((star) => {
        star.addEventListener("mouseover", () => {
          clearHover();
          const value = parseInt(star.dataset.value);
          highlightStars(value, "hover");
        });

        star.addEventListener("mouseout", () => {
          clearHover();
        });

        star.addEventListener("click", () => {
          //TODO:修改实际内容
          currentRating = parseInt(star.dataset.value);
          highlightStars(currentRating, "selected");

          console.log("star click");
        });
      });

      this.shadowRoot
        .getElementById("rating")
        .addEventListener("mouseleave", resetSelected);

      function highlightStars(rating, className) {
        stars.forEach((star) => {
          if (parseInt(star.dataset.value) <= rating) {
            star.classList.add(className);
          } else {
            star.classList.remove(className);
          }
        });
      }

      function clearHover() {
        stars.forEach((star) => {
          star.classList.remove("hover");
        });
      }

      // 初始化已评分状态
      function resetSelected() {
        stars.forEach((star) => {
          star.classList.remove("selected");
        });
        if (currentRating > 0) {
          highlightStars(currentRating, "selected");
        }
      }
    }
  }

  customElements.define("star-rating", StarRating);
</script>
