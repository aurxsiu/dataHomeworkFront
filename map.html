<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./src/mapCss.css" />
    <title>map</title>
  </head>
  <body>
    <h1>hello</h1>
    <div class="search-container">
      <input
        type="text"
        id="search-input"
        placeholder="输入搜索内容..."
        autocomplete="off"
      />
      <div id="suggestions" class="suggestions hidden"></div>
    </div>
    <svg
      id="map"
      viewBox="0 0 1600 900"
      preserveAspectRatio="xMidYMid meet"
    ></svg>
  </body>
  <script>
    console.log("hello");
    console.log(localStorage.getItem("userId"));

    //search
    const input = document.getElementById("search-input");
    const suggestionsBox = document.getElementById("suggestions");

    input.addEventListener("input", function () {
      const query = this.value.trim();

      if (query === "") {
        suggestionsBox.classList.add("hidden");
        suggestionsBox.innerHTML = "";
        return;
      }

      fetch("http://localhost:8080/map/search", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          input: query,
        }),
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("网络响应失败");
          }
          return response.json();
        })
        .then((data) => {
          const suggestions = data.result;
          if (suggestions.length === 0) {
            suggestionsBox.classList.add("hidden");
            suggestionsBox.innerHTML = "";
            return;
          }

          suggestionsBox.innerHTML = "";
          suggestions.forEach((item) => {
            const div = document.createElement("div");
            div.textContent = item.name;
            div.classList.add("suggestion-item");
            div.mapType = item.type;
            div.addEventListener("click", () => {
              input.value = div.textContent;
              suggestionsBox.classList.add("hidden");
              fetch("http://localhost:8080/map/getMap", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ type: div.mapType }),
              })
                .then((response) => {
                  return response.json();
                })
                .then((data) => {
                  data = data.map;
                  nodes = data.nodes;
                  connections = data.connections;
                  drawMap();
                });
            });
            suggestionsBox.appendChild(div);
          });
          suggestionsBox.classList.remove("hidden");
        });
    });

    // 点击页面其他地方关闭下拉
    document.addEventListener("click", (e) => {
      if (!document.querySelector(".search-container").contains(e.target)) {
        suggestionsBox.classList.add("hidden");
      }
    });

    var nodes;
    var connections;
    //MAP图
    const svg = document.getElementById("map");
    const viewBox = { x: 0, y: 0, width: 1600, height: 900 };
    const scaleFactor = 1.1;
    function updateViewBox() {
      svg.setAttribute(
        "viewBox",
        `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`
      );
      const zoomRatio = 1600 / viewBox.width;
      svg
        .querySelectorAll("path")
        .forEach((p) => p.setAttribute("stroke-width", 6 / zoomRatio));
      svg
        .querySelectorAll("circle")
        .forEach((c) => c.setAttribute("r", 5 / zoomRatio));
    }

    svg.addEventListener("wheel", (e) => {
      e.preventDefault();
      const scale = e.deltaY < 0 ? 1 / scaleFactor : scaleFactor;
      const rect = svg.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      const svgX = viewBox.x + (mx / rect.width) * viewBox.width;
      const svgY = viewBox.y + (my / rect.height) * viewBox.height;
      viewBox.x = svgX - (svgX - viewBox.x) * scale;
      viewBox.y = svgY - (svgY - viewBox.y) * scale;
      viewBox.width *= scale;
      viewBox.height *= scale;
      updateViewBox();
    });
    let isPanning = false,
      start = {};
    svg.addEventListener("mousedown", (e) => {
      isPanning = true;
      start.x = e.clientX;
      start.y = e.clientY;
      svg.style.cursor = "grabbing";
    });
    svg.addEventListener("mousemove", (e) => {
      if (!isPanning) return;
      const dx = (e.clientX - start.x) * (viewBox.width / svg.clientWidth);
      const dy = (e.clientY - start.y) * (viewBox.height / svg.clientHeight);
      viewBox.x -= dx;
      viewBox.y -= dy;
      start.x = e.clientX;
      start.y = e.clientY;
      updateViewBox();
    });
    svg.addEventListener("mouseup", () => {
      isPanning = false;
    });
    svg.addEventListener("mouseleave", () => {
      isPanning = false;
    });

    function drawMap() {
      svg.innerHTML = "";
      for (const conn of connections) {
        const p1 = nodes.find((n) => n.id === conn[0]);
        const p2 = nodes.find((n) => n.id === conn[1]);
        const cx = (p1.x + p2.x) / 2 + (Math.random() - 0.5) * 60;
        const cy = (p1.y + p2.y) / 2 + (Math.random() - 0.5) * 60;
        const d = `M${p1.x},${p1.y} Q${cx},${cy} ${p2.x},${p2.y}`;
        const path = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path"
        );
        path.setAttribute("d", d); //贝塞尔曲线
        path.setAttribute("stroke", `hsl(${Math.random() * 360}, 80%, 60%)`); //颜色
        path.setAttribute("stroke-width", 6);
        svg.appendChild(path);
      }
      for (const n of nodes) {
        const c = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "circle"
        );
        c.setAttribute("cx", n.x);
        c.setAttribute("cy", n.y);
        c.setAttribute("r", 5);
        const title = document.createElement("title");
        title.textContent = n.name;
        c.appendChild(title);
        svg.appendChild(c);
      }
      updateViewBox();
    }
  </script>
</html>
